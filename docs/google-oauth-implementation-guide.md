# Google OAuth Implementation Guide

## üìã Table of Contents
1. [Overview](#overview)
2. [Google Cloud Console Setup](#google-cloud-console-setup)
3. [Supabase Configuration](#supabase-configuration)
4. [Frontend Implementation](#frontend-implementation)
5. [Backend Callback Handling](#backend-callback-handling)
6. [Environment Variables](#environment-variables)
7. [Testing the Implementation](#testing-the-implementation)
8. [Troubleshooting](#troubleshooting)

---

## üèóÔ∏è Overview

Google OAuth allows users to sign in to your application using their Google account. This guide shows how to implement it using Supabase Auth with Next.js.

### **How It Works:**
1. User clicks "Sign in with Google" button
2. User is redirected to Google's authorization server
3. User grants permission to your app
4. Google redirects back to your app with an authorization code
5. Your app exchanges the code for user information
6. User is signed in to your application

---

## üîß Google Cloud Console Setup

### Step 1: Create a Google Cloud Project

1. **Go to Google Cloud Console**
   - Visit [console.cloud.google.com](https://console.cloud.google.com)
   - Sign in with your Google account

2. **Create New Project**
   ```
   1. Click "Select a project" dropdown
   2. Click "New Project"
   3. Enter project name: "PantryPal AI"
   4. Click "Create"
   ```

### Step 2: Enable Google+ API

1. **Navigate to APIs & Services**
   ```
   1. Go to "APIs & Services" > "Library"
   2. Search for "Google+ API"
   3. Click on "Google+ API"
   4. Click "Enable"
   ```

### Step 3: Configure OAuth Consent Screen

1. **Go to OAuth Consent Screen**
   ```
   APIs & Services > OAuth consent screen
   ```

2. **Configure Consent Screen**
   ```
   User Type: External (for public apps)
   
   App Information:
   - App name: PantryPal AI
   - User support email: your-email@example.com
   - Developer contact: your-email@example.com
   
   Scopes:
   - email
   - profile
   - openid
   
   Test users: (Add your email for testing)
   ```

### Step 4: Create OAuth Credentials

1. **Go to Credentials**
   ```
   APIs & Services > Credentials > Create Credentials > OAuth 2.0 Client IDs
   ```

2. **Configure OAuth Client**
   ```
   Application type: Web application
   Name: PantryPal AI Web Client
   
   Authorized JavaScript origins:
   - http://localhost:3000 (for development)
   - https://your-domain.com (for production)
   
   Authorized redirect URIs:
   - http://localhost:3000/auth/callback (for development)
   - https://your-domain.com/auth/callback (for production)
   ```

3. **Save Credentials**
   ```
   Copy the Client ID and Client Secret
   You'll need these for Supabase configuration
   ```

---

## üóÑÔ∏è Supabase Configuration

### Step 1: Access Supabase Dashboard

1. **Go to Supabase Dashboard**
   - Visit [supabase.com/dashboard](https://supabase.com/dashboard)
   - Select your project

### Step 2: Configure Google OAuth Provider

1. **Navigate to Authentication**
   ```
   Authentication > Providers > Google
   ```

2. **Enable Google Provider**
   ```
   Enable Google provider: ON
   
   Client ID: [Your Google OAuth Client ID]
   Client Secret: [Your Google OAuth Client Secret]
   
   Redirect URL: (This is auto-generated by Supabase)
   Copy this URL - you'll need it for Google Console
   ```

3. **Update Google Console Redirect URI**
   ```
   Go back to Google Cloud Console > Credentials
   Add the Supabase redirect URL to "Authorized redirect URIs"
   ```

---

## üíª Frontend Implementation

### Step 1: Install Dependencies

```bash
npm install @supabase/supabase-js @supabase/ssr
```

### Step 2: Create Supabase Client

```typescript
// src/lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr';

export const createClient = () => {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
};
```

### Step 3: Create Google Sign-In Component

```typescript
// src/components/auth/GoogleSignIn.tsx
'use client';

import { useState } from 'react';
import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';

export function GoogleSignIn() {
  const [isLoading, setIsLoading] = useState(false);
  const supabase = createClient();

  const handleGoogleLogin = async () => {
    try {
      setIsLoading(true);
      
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent',
          },
        },
      });

      if (error) {
        toast.error(error.message);
        console.error('Google OAuth error:', error);
      }
    } catch (error) {
      toast.error('An error occurred during Google login');
      console.error('Google login error:', error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Button 
      variant="outline"
      onClick={handleGoogleLogin}
      disabled={isLoading}
      className="w-full"
    >
      <svg className="mr-2 h-4 w-4" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
        />
        <path
          fill="currentColor"
          d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
        />
        <path
          fill="currentColor"
          d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
        />
        <path
          fill="currentColor"
          d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
        />
      </svg>
      {isLoading ? 'Signing in...' : 'Continue with Google'}
    </Button>
  );
}
```

### Step 4: Create Login Page

```typescript
// src/app/(auth)/login/page.tsx
import { GoogleSignIn } from '@/components/auth/GoogleSignIn';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export default function LoginPage() {
  return (
    <div className="flex justify-center items-center min-h-screen px-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-2xl font-bold text-center">
            Sign In
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <GoogleSignIn />
          
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-background px-2 text-muted-foreground">
                Or continue with
              </span>
            </div>
          </div>
          
          {/* Add email/password form here if needed */}
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## üîÑ Backend Callback Handling

### Step 1: Create Auth Callback Route

```typescript
// src/app/auth/callback/route.ts
import { createServerClient } from '@supabase/ssr';
import { NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function GET(request: Request) {
  const requestUrl = new URL(request.url);
  const code = requestUrl.searchParams.get('code');
  const origin = requestUrl.origin;

  if (code) {
    const cookieStore = await cookies();
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return cookieStore.getAll();
          },
          setAll(cookiesToSet) {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          },
        },
      }
    );

    const { error } = await supabase.auth.exchangeCodeForSession(code);
    
    if (error) {
      console.error('Error exchanging code for session:', error);
      return NextResponse.redirect(`${origin}/login?error=auth_callback_error`);
    }

    // Get user data after successful authentication
    const { data: { user } } = await supabase.auth.getUser();
    
    if (user) {
      console.log('User authenticated:', {
        id: user.id,
        email: user.email,
        name: user.user_metadata?.full_name,
        avatar: user.user_metadata?.avatar_url
      });
    }
  }

  // Redirect to dashboard or home page
  return NextResponse.redirect(`${origin}/dashboard`);
}
```

### Step 2: Create Server-Side Supabase Client

```typescript
// src/lib/supabase/server.ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export const createClient = async () => {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) =>
            cookieStore.set(name, value, options)
          );
        },
      },
    }
  );
};
```

---

## üîê Environment Variables

### Step 1: Create Environment File

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### Step 2: Add to .env.example

```bash
# .env.example
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

---

## üß™ Testing the Implementation

### Step 1: Test Locally

1. **Start Development Server**
   ```bash
   npm run dev
   ```

2. **Navigate to Login Page**
   ```
   http://localhost:3000/login
   ```

3. **Click Google Sign-In Button**
   - Should redirect to Google OAuth consent screen
   - Grant permissions
   - Should redirect back to your app

### Step 2: Verify User Data

```typescript
// Check user data in your app
const { data: { user } } = await supabase.auth.getUser();

console.log('User data:', {
  id: user?.id,
  email: user?.email,
  name: user?.user_metadata?.full_name,
  avatar: user?.user_metadata?.avatar_url,
  provider: user?.app_metadata?.provider
});
```

---

## üîß Troubleshooting

### Common Issues

1. **"redirect_uri_mismatch" Error**
   ```
   Solution: Ensure redirect URIs in Google Console match exactly
   - Check for trailing slashes
   - Verify HTTP vs HTTPS
   - Confirm domain spelling
   ```

2. **"Invalid Client" Error**
   ```
   Solution: Verify Google OAuth credentials in Supabase
   - Check Client ID and Secret
   - Ensure they're from the correct Google project
   ```

3. **Callback Route Not Working**
   ```
   Solution: Verify callback route implementation
   - Check file location: src/app/auth/callback/route.ts
   - Ensure proper error handling
   - Verify environment variables
   ```

### Debug Tips

1. **Enable Detailed Logging**
   ```typescript
   const { data, error } = await supabase.auth.signInWithOAuth({
     provider: 'google',
     options: {
       redirectTo: `${window.location.origin}/auth/callback`,
     },
   });
   
   console.log('OAuth response:', { data, error });
   ```

2. **Check Network Tab**
   - Monitor requests to Google OAuth
   - Verify redirect URLs
   - Check for CORS issues

---

## üë§ Using Google OAuth User Data

### Step 1: Access User Information

```typescript
// Get current user data
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  const userData = {
    id: user.id,                                    // Unique user ID
    email: user.email,                              // user@gmail.com
    name: user.user_metadata?.full_name,            // "John Doe"
    firstName: user.user_metadata?.given_name,      // "John"
    lastName: user.user_metadata?.family_name,      // "Doe"
    avatar: user.user_metadata?.avatar_url,         // Profile picture URL
    provider: user.app_metadata?.provider,          // "google"
    emailVerified: user.email_confirmed_at,         // Verification timestamp
  };
}
```

### Step 2: Create User Profile Component

```typescript
// src/components/user/UserProfile.tsx
'use client';

import { useEffect, useState } from 'react';
import { createClient } from '@/lib/supabase/client';
import { User } from '@supabase/supabase-js';

export function UserProfile() {
  const [user, setUser] = useState<User | null>(null);
  const supabase = createClient();

  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      setUser(user);
    };

    getUser();

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        setUser(session?.user ?? null);
      }
    );

    return () => subscription.unsubscribe();
  }, [supabase]);

  if (!user) return <div>Please sign in</div>;

  return (
    <div className="flex items-center space-x-4">
      {user.user_metadata?.avatar_url && (
        <img
          src={user.user_metadata.avatar_url}
          alt="Profile"
          className="w-10 h-10 rounded-full"
        />
      )}
      <div>
        <p className="font-medium">{user.user_metadata?.full_name}</p>
        <p className="text-sm text-gray-500">{user.email}</p>
      </div>
    </div>
  );
}
```

### Step 3: Protect Routes with Authentication

```typescript
// src/app/dashboard/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';

export default async function DashboardPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  return (
    <div>
      <h1>Welcome, {user.user_metadata?.full_name}!</h1>
      <p>Email: {user.email}</p>
      {/* Dashboard content */}
    </div>
  );
}
```

### Step 4: Sign Out Functionality

```typescript
// src/components/auth/SignOut.tsx
'use client';

import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';

export function SignOut() {
  const supabase = createClient();
  const router = useRouter();

  const handleSignOut = async () => {
    await supabase.auth.signOut();
    router.push('/');
    router.refresh();
  };

  return (
    <Button onClick={handleSignOut} variant="outline">
      Sign Out
    </Button>
  );
}
```

---

## üéØ Your PantryPal AI Implementation

### ‚úÖ What's Already Working

Your PantryPal AI already has Google OAuth perfectly implemented:

1. **Google Sign-In Button** - Working on login and signup pages
2. **OAuth Callback Handling** - Proper session management
3. **User Data Access** - Profile information available
4. **Protected Routes** - Dashboard requires authentication
5. **Sign Out Functionality** - Complete auth flow

### üîç Current Implementation Files

```
src/app/(auth)/login/page.tsx     - Login page with Google OAuth
src/app/(auth)/signup/page.tsx    - Signup page with Google OAuth
src/app/auth/callback/route.ts    - OAuth callback handler
src/lib/supabase/client.ts        - Browser Supabase client
src/lib/supabase/server.ts        - Server Supabase client
```

### üöÄ Ready to Use

Your Google OAuth is production-ready and working at:
- **Live URL**: https://www.pantrypal-ai.space/login
- **Test it**: Click the Google button and sign in!

This guide provides a complete implementation of Google OAuth authentication. Your PantryPal AI already has this working perfectly!
